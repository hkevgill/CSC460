<!DOCTYPE HTML>
<html>
	<head>
		<title>Project 2</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
	</head>
	<body class="no-sidebar">
		<div id="page-wrapper">

			<!-- Header -->
				<div id="header-wrapper">
					<div id="header">

						<!-- Logo -->
							<h1><a href="index.html">Project 2</a></h1>

						<!-- Nav -->
							<nav id="nav">
								<ul>
									<li><a href="index.html">Home</a></li>
									<li><a href="project1.html">Project 1</a></li>
									<li class="current"><a href="project2.html">Project 2</a></li>
									<li><a href="project3.html">Project 3</a></li>
								</ul>
							</nav>

					</div>
				</div>

			<!-- Main -->
				<div id="main-wrapper">
					<div class="container">

						<!-- Content -->
							<article class="box post">
								
								<a href="#" class="image featured"><img src="images/tron.jpg" alt="" /></a>
								<header>
									<h2>Project 2</h2>
								</header>

								<section>
									<header>
										<h3>Introduction</h3>
									</header>
									<p>
										The goal of project 2 is to implement, and test a priority based, preemptive, multithreaded real time operating system (RTOS). This is done on the same microcontroller as in project 1, the ATMega 2560. The RTOS will have similar features to the pthread library including mutexes and priority inheritence.
									</p>
								</section>

								<section>
									<header>
										<h3>Hardware</h3>
									</header>
									<h4>Arduino ATMega 2560</h4>
									<a class="image paragraph"><img src="images/mega2560.jpg"></a>
									<p>
										The ATMega 2560 is an Atmel 8-bit AVR RISC based microcontroller with 256 KB of flash memory and 8 KB of SDRAM running at 16MHz. 
									</p>
									<h4>17-Bit Address Problem</h4>
									<p>
										AVR architectures store instructions in the flash part of memory. This memory is normally accessed by 2 byte words that are addressed with 16 bit addresses. This means the maximum amount of memory that can be addressed by 16 bits is 2*2^16 bytes, or 128 KB. Since the ATMega has 256 KB of flash, it uses extended addressing to address the upper part of memory. This means the CPU effectively uses a 17 bit address, with an extra bit stored in the EIND (extended indirect) register. The compiler then calls functions in memory using special instructions (like eijmp and eicall), that concatenate the EIND register with the 16 bit Z (r30 and r31) register that stores the the first 16 bits of the address.

										In order to fix the 17-bit address problem in the RTOS, the RTOS needs to store the EIND register when it saves a task's context, and restore the EIND register when it restores a task's context. Also when the workspace for a task is initialized, there needs to be a 3 byte (instead of a 2 byte) return address for the program counter. Context switching will be illustrated later, but these two fixes are shown below:
									</p>
									<a class="image paragraph"><img src="images/17-bit-problem1.png"></a>
									<br>
									<a class="image paragraph"><img src="images/17-bit-problem2.png"></a>
									<br>
									<p>
										As you can see, the third byte is set to 0 when the task is initialized.
									</p>
								</section>

								<section>
									<header>
										<h3>RTOS Design</h3>
									</header>

									<h4>Booting, Context Switching and the Kernel</h4>
									<b>RTOS Booting</b>
									<p>
										When the RTOS boots, it makes a one-time call to OS_Init, which initializes all of the important counts and memory allocations necessary for operation.

										In this RTOS, threads are represented by "tasks". Each task is represented by a process descriptor, which contains all location and state information about each task. In addition, each process descriptor contains a memory "workspace" of 256 bytes for storing the register values and return address for context-switching. Memory for 16 (MAXTHREAD) of these processes is allocated upon initial booting of the RTOS. 

										Likewise, memory is allocated for 8 Mutexes and 8 Events (both of which are covered in later sections).
									</p>

									<b>Timers and Interrupts</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>The Kernel</b>
									<p>
										Lorem Ipsum.  
									</p>

									<b>a_main?</b>
									<p>
										Lorem Ipsum?  
									</p>
									
									<h4>Priority Scheduling</h4>
									<b>Dispatch</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Tasks</h4>
									<b>Overview</b>
									<p>
										As mentioned in RTOS Booting, each task is represented by a process descriptor...
									</p>
									<b>Task Next</b>
									<p>
										Task_Next sets the kernel request to NEXT and enters the kernel. The kernel simply sets the current state to READY, enqueues the current process into the ReadyQueue, and calls Dispatch.
									</p>
									<b>Task Create</b>
									<p>
										Task_Create is called with three parameters: a pointer to the function that is to run as the task, an integer value for the initial priority of the task, and an integer value for the task's "arg". 
									</p>

									<b>Task GetArg</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>Task Suspend</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>Task Resume</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>Task Sleep</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>Task Terminate</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Mutexes and Priority Inheritence</h4>
									<b>Overview</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Mutex Lock</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>Mutex Unlock</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Events</h4>
									<b>Overview</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Event Wait</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>Event Signal</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Error Handling</h4>
									<b>Recoverable Errors</b>
									<p>
										Lorem Ipsum.
									</p>

									<b>Unrecoverable Errors</b>
									<p>
										Lorem Ipsum.
									</p>
								</section>

								<section>
									<header>
										<h3>Testing and Profiling</h3>
									</header>
									<h4>Task Termination</h4>
									<b>Test 1</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 2</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Suspend &amp; Resume</h4>
									<b>Test 1</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 2</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Task Sleep</h4>
									<b>Test 1</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Mutexes</h4>
									<b>Test 1</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 2</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 3</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 4</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 5</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 6</b>
									<p>
										Lorem Ipsum.
									</p>

									<h4>Events</h4>
									<b>Test 1</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 2</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Test 3</b>
									<p>
										Lorem Ipsum.
									</p>
								</section>

								<section>
									<header>
										<h3>RTOS Timing Measurements</h3>
									</header>
									<b>Dispatch</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Context Switching</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Tasks</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Mutexes</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Events</b>
									<p>
										Lorem Ipsum.
									</p>
								</section>

								<section>
									<header>
										<h3>Future Improvements</h3>
									</header>
									<b>Returning to Interrupt Handler</b>
									<p>
										Lorem Ipsum.
									</p>
									<b>Sleeping CPU during down-time</b>
									<p>
										Lorem Ipsum.
									</p>
								</section>

								<section>
									<header>
										<h3>References</h3>
									</header>
									<ul>
										<li></li>
									</ul>
								</section>

								<section>
									<header>
										<h3>Code</h3>
									</header>
									<p>
										Download the project 2 source code <a href="http://www.roombatank.com/project2.zip">here</a>.
									</p>
								</section>

							</article>
					</div>
				</div>

			<!-- Footer -->
				<div id="footer-wrapper">
					<section id="footer" class="container">
						<div class="row">
							<div class="12u">

								<!-- Copyright -->
									<div id="copyright">
										<ul class="links">
											<li>ROOMBA TANK &copy; 2016</li>
										</ul>
									</div>

							</div>
						</div>
					</section>
				</div>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/skel-viewport.min.js"></script>
			<script src="assets/js/util.js"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="assets/js/main.js"></script>

	</body>
</html>